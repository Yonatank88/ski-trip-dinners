<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ski Trip Dinners | Montriond 2025</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <nav>
    <a href="index.html" class="active">Dinners</a>
    <a href="shopping.html">Shopping List</a>
  </nav>

  <main>
    <header class="header">
      <h1>Ski Trip Dinners</h1>
      <p class="location">
        <svg viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>
        Montriond, France
      </p>
      <div class="meta">
        <span class="meta-item">12 People</span>
        <span class="meta-item">2 Vegan</span>
        <span class="meta-item">6 Nights</span>
      </div>
    </header>

    <div id="meals-container"></div>
  </main>

  <script src="data.js"></script>
  <script>
    const container = document.getElementById('meals-container');
    const chevronSvg = `<svg viewBox="0 0 24 24"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/></svg>`;

    meals.forEach(meal => {
      if (meal.dishes.length === 0) return;

      const card = document.createElement('div');
      card.className = 'meal-card';

      // Group dishes by type
      const mains = meal.dishes.filter(d => d.type === 'main');
      const vegan = meal.dishes.filter(d => d.type === 'vegan');
      const sides = meal.dishes.filter(d => d.type === 'side');
      const sauces = meal.dishes.filter(d => d.type === 'sauce');
      const prep = meal.dishes.filter(d => d.type === 'prep');

      // Helper to render dish with ingredients
      const renderDish = (d, meal) => {
        const ingredientsList = d.ingredients.map(ingName => {
          const details = meal.ingredients.find(i => i.item === ingName);
          const cat = details ? details.category : 'dry';
          const qty = details ? details.qty : '';
          return `<li><span class="dot ${cat}"></span>${ingName}${qty ? ' · ' + qty : ''}</li>`;
        }).join('');

        return `
          <div class="dish-item ${d.type}${d.image ? ' has-image' : ''}" data-dish="${d.name}">
            ${d.image ? `<div class="dish-image"><img src="${d.image}" alt="${d.name}" loading="lazy"></div>` : ''}
            <div class="dish-info">
              <div class="dish-name">${d.name}</div>
              <div class="dish-meta">${d.type}</div>
            </div>
            <div class="dish-ingredients">
              <ul>${ingredientsList}</ul>
            </div>
          </div>
        `;
      };

      card.innerHTML = `
        <div class="meal-header">
          <h2>${meal.name}</h2>
          <span class="day-badge">${meal.day}</span>
          ${meal.chefsBitches && meal.chefsBitches.length > 0 ? `
          <div class="chefs-bitches">
            <span class="bitches-label">Chef's Bitches:</span>
            <span class="bitches-names">${meal.chefsBitches.join(', ')}</span>
          </div>
          ` : ''}
        </div>
        <div class="meal-content">
          <div class="dishes-section">
            <h3>On the Menu</h3>
            <div class="dishes-grid">
              ${mains.map(d => renderDish(d, meal)).join('')}
              ${vegan.map(d => renderDish(d, meal)).join('')}
              ${sides.map(d => renderDish(d, meal)).join('')}
              ${sauces.map(d => renderDish(d, meal)).join('')}
              ${prep.map(d => renderDish(d, meal)).join('')}
            </div>
          </div>

          <button class="section-toggle" data-section="ingredients-${meal.id}">
            <h3>Ingredients (<span class="ing-count" id="ing-count-${meal.id}">${meal.ingredients.length}</span>)</h3>
            ${chevronSvg}
          </button>
          <div class="section-content" id="ingredients-${meal.id}">
            <button class="edit-toggle-btn" data-meal-id="${meal.id}">
              <svg viewBox="0 0 24 24" width="14" height="14"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a1 1 0 000-1.41l-2.34-2.34a1 1 0 00-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
              Edit
            </button>
            <div class="ingredients-grid" id="ing-grid-${meal.id}">
              ${meal.ingredients.map(i => `
                <span class="ingredient-tag">
                  <span class="cat ${i.category}"></span>
                  ${i.item} · ${i.qty}
                </span>
              `).join('')}
            </div>
            <div class="ingredients-edit-list" id="ing-edit-${meal.id}" style="display:none;">
            </div>
          </div>

          <button class="section-toggle" data-section="prep-before-${meal.id}">
            <h3>Prep Before</h3>
            ${chevronSvg}
          </button>
          <div class="section-content" id="prep-before-${meal.id}">
            <ul class="prep-list">
              ${meal.prepBefore.map(p => `<li>${p}</li>`).join('')}
            </ul>
          </div>

          <button class="section-toggle" data-section="same-day-${meal.id}">
            <h3>Same Day</h3>
            ${chevronSvg}
          </button>
          <div class="section-content" id="same-day-${meal.id}">
            <ul class="prep-list">
              ${meal.prepSameDay.map(p => `<li>${p}</li>`).join('')}
            </ul>
          </div>

          ${meal.brineRecipe ? `
          <button class="section-toggle" data-section="brine-${meal.id}">
            <h3>Brine Recipe</h3>
            ${chevronSvg}
          </button>
          <div class="section-content" id="brine-${meal.id}">
            <div class="recipe-card">
              <h4>${meal.brineRecipe.title}</h4>
              <div class="recipe-ingredients">
                <strong>Ingredients:</strong>
                <ul>${meal.brineRecipe.ingredients.map(i => `<li>${i}</li>`).join('')}</ul>
              </div>
              <div class="recipe-steps">
                <strong>Steps:</strong>
                <ol>${meal.brineRecipe.steps.map(s => `<li>${s}</li>`).join('')}</ol>
              </div>
            </div>
          </div>
          ` : ''}
        </div>
      `;

      container.appendChild(card);
    });

    // Toggle sections
    document.querySelectorAll('.section-toggle').forEach(btn => {
      btn.addEventListener('click', () => {
        const sectionId = btn.dataset.section;
        const section = document.getElementById(sectionId);
        btn.classList.toggle('open');
        section.classList.toggle('open');
      });
    });

    // Toggle dish ingredients on click
    document.querySelectorAll('.dish-item').forEach(dish => {
      dish.addEventListener('click', () => {
        dish.classList.toggle('expanded');
      });
    });

    // ==================== EDIT FUNCTIONALITY ====================

    function renderIngredientGrid(mealId) {
      const meal = meals.find(m => m.id === mealId);
      const grid = document.getElementById(`ing-grid-${mealId}`);
      grid.innerHTML = meal.ingredients.map(i => `
        <span class="ingredient-tag">
          <span class="cat ${i.category}"></span>
          ${i.item} · ${i.qty}
        </span>
      `).join('');
      document.getElementById(`ing-count-${mealId}`).textContent = meal.ingredients.length;
    }

    function renderEditList(mealId) {
      const meal = meals.find(m => m.id === mealId);
      const editContainer = document.getElementById(`ing-edit-${mealId}`);
      editContainer.innerHTML = `
        <div class="edit-items">
          ${meal.ingredients.map(i => `
            <div class="edit-row" data-item="${i.item}">
              <span class="cat ${i.category}"></span>
              <span class="edit-item-name">${i.item}</span>
              <input type="text" class="edit-qty-input" value="${i.qty}" data-meal="${mealId}" data-item="${i.item}">
              <button class="edit-delete-btn" data-meal="${mealId}" data-item="${i.item}" title="Remove ingredient">
                <svg viewBox="0 0 24 24" width="14" height="14"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
              </button>
            </div>
          `).join('')}
        </div>
        <div class="add-ingredient-form">
          <h4>Add Ingredient</h4>
          <div class="add-row">
            <input type="text" class="add-input add-name" placeholder="Ingredient name" data-meal="${mealId}">
            <input type="text" class="add-input add-qty" placeholder="Qty" data-meal="${mealId}">
            <select class="add-input add-cat" data-meal="${mealId}">
              <option value="veg">Veg</option>
              <option value="meat">Meat</option>
              <option value="dairy">Dairy</option>
              <option value="dry">Dry</option>
            </select>
            <button class="add-btn" data-meal="${mealId}">Add</button>
          </div>
        </div>
      `;

      // Attach event listeners for qty changes
      editContainer.querySelectorAll('.edit-qty-input').forEach(input => {
        input.addEventListener('change', () => {
          updateMealIngredient(mealId, input.dataset.item, input.value.trim());
        });
      });

      // Attach delete listeners
      editContainer.querySelectorAll('.edit-delete-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const itemName = btn.dataset.item;
          if (confirm('Remove "' + itemName + '" from this meal?')) {
            deleteMealIngredient(mealId, itemName);
            renderEditList(mealId);
            renderIngredientGrid(mealId);
          }
        });
      });

      // Attach add listener
      const addBtn = editContainer.querySelector('.add-btn');
      addBtn.addEventListener('click', () => {
        const nameInput = editContainer.querySelector('.add-name');
        const qtyInput = editContainer.querySelector('.add-qty');
        const catSelect = editContainer.querySelector('.add-cat');
        const name = nameInput.value.trim();
        const qty = qtyInput.value.trim();
        const category = catSelect.value;
        if (!name) { nameInput.focus(); return; }
        if (!qty) { qtyInput.focus(); return; }
        const added = addMealIngredient(mealId, name, category, qty);
        if (added === false) {
          alert('This ingredient already exists in the meal.');
          return;
        }
        nameInput.value = '';
        qtyInput.value = '';
        renderEditList(mealId);
        renderIngredientGrid(mealId);
      });
    }

    // Edit toggle buttons
    document.querySelectorAll('.edit-toggle-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const mealId = parseInt(btn.dataset.mealId);
        const grid = document.getElementById(`ing-grid-${mealId}`);
        const editList = document.getElementById(`ing-edit-${mealId}`);
        const isEditing = btn.classList.contains('active');

        if (isEditing) {
          // Exit edit mode
          btn.classList.remove('active');
          btn.innerHTML = `<svg viewBox="0 0 24 24" width="14" height="14"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a1 1 0 000-1.41l-2.34-2.34a1 1 0 00-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg> Edit`;
          grid.style.display = '';
          editList.style.display = 'none';
          renderIngredientGrid(mealId);
        } else {
          // Enter edit mode
          btn.classList.add('active');
          btn.innerHTML = `<svg viewBox="0 0 24 24" width="14" height="14"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg> Done`;
          grid.style.display = 'none';
          editList.style.display = 'block';
          renderEditList(mealId);
        }
      });
    });
  </script>
</body>
</html>
